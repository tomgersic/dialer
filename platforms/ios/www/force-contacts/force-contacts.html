<link rel="import" href="../components/polymer/polymer.html">
<polymer-element name="force-contacts" attributes="contacts">
  <template>
    <style>
    :host {
      display: none;
    }
    </style>
  </template>
  <script>
  Polymer('force-contacts', {
    created: function() {
      this.contacts = [];
      this.cache = {};
      this.models = {};
    },
    ready:function() {
      var forceclient = document.querySelector('forceclient-service');

      var that = this;

      //set up contact model
      this.models.Contact = Force.SObject.extend({
        sobjectType: "Contact",
        fieldlist: ["Id","Name","Email","Phone"],
        cache: function() { return that.cache; },
        cacheMode: function(method) {
          if (!forceclient.offlineTracker.get("isOnline")) {
            return Force.CACHE_MODE.CACHE_ONLY;
          }
          else {
            return (method == "read" ? Force.CACHE_MODE.CACHE_FIRST : Force.CACHE_MODE.SERVER_FIRST);
          }
        }
      });

      //set up contact collection
      this.models.ContactCollection = Force.SObjectCollection.extend({
        model: this.models.Contact,
        fieldlist: ["Id","Name","Email","Phone"],
        cache: function() { return that.cache; },
        config: function() {
          if(!forceclient.offlineTracker.get('isOnline')) {
            console.log("*******I THINK I'M OFFLINE");
            return {
              type:"cache", 
              cacheQuery: {queryType:"range", indexPath:"Id", order:"ascending", pageSize:250}
            };
          }
          else {
            console.log("*******I THINK I'M ONLINE");

            return {
              type:"mru", sobjectType:"Contact", fieldlist: this.fieldlist, orderBy:"LastModifiedDate", orderDirection:"DESC"
            };
          }
        }  
      });



      //authenticate
      forceclient.authenticateUser(this,function(that,client){

        that.setupCache(that);

        //instantiate and fetch Contacts
        var mycontacts = new that.models.ContactCollection();

        mycontacts.fetch({           
          success: function(data) {
            that.contacts = data.toJSON();
          },
          error: function(error) {
            alert("Failed to get Contacts");
            console.log(error);
          }
        });
      })
    },
    setupCache: function(that) {
      //set up contacts cache
      that.cache = new Force.StoreCache("contacts", [ {path:"Name", type:"string"} ]);
      return $.when(that.cache.init());
    }
  });
  </script>
</polymer-element>
